C51 COMPILER V9.60.0.0   MAIN                                                              11/10/2021 10:38:04 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\src\main.c OMF2 OPTIMIZE(8,SPEED) BROWSE INCDIR(..\..\inc;..\..\pr
                    -j) DEBUG PRINT(.\Listings\main.lst) OBJECT(.\Objects\main.obj)

line level    source

   1          /*
   2           * charger-test.c
   3           *
   4           * CHARGER test.
   5           *
   6           * Author: zhanyingwei<3080940495@qq.com>
   7           * 
   8           * Copyright (C) 2021 Sinh Micro, Inc.
   9           *
  10           * Licensed under the Apache License, Version 2.0 (the "License");
  11           * you may not use this file except in compliance with the License.
  12           * You may obtain a copy of the License at
  13           *
  14           *     http://www.apache.org/licenses/LICENSE-2.0
  15           *
  16           * Unless required by applicable law or agreed to in writing, software
  17           * distributed under the License is distributed on an "AS IS" BASIS,
  18           * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  19           * See the License for the specific language governing permissions and
  20           * limitations under the License.
  21           */
  22          
  23          #include "ss881x.h"
  24          
  25          short vbat_mv;
  26          unsigned char num[5] ;
  27          
  28          static void _delay_ms(unsigned char ms)
  29          {       
  30   1          unsigned char i, j;
  31   1          do {
  32   2              i = 4;
  33   2              j = 200;
  34   2              do
  35   2              {
  36   3                  while (--j);
  37   3              } while (--i);
  38   2          } while (--ms);
  39   1      }
  40          
  41          void uart_init()
  42          {
  43   1              BRDSRC = 1;                          /* Using UART internal baud rate generator */
  44   1              BRPRE  = 1;                          /* prescaled to 13 */
  45   1              
  46   1              BR8  = 1;
  47   1              SBR  = 0xD0;                         /* bps = 19200 */
  48   1      }
  49          
  50          void adc_init()
  51          {
  52   1          ADCCON0  &= ~0x40;                   /* continuity sampling */
  53   1          ADCCHEN  |= 0x01;                    /* enable VBAT channel */
  54   1      }
C51 COMPILER V9.60.0.0   MAIN                                                              11/10/2021 10:38:04 PAGE 2   

  55          
  56          void charger_init()
  57          {
  58   1              CLKCON1  |= 0x08;                    /* send clock to charger */
  59   1              
  60   1              CHGCON0  |= 0xA0;                    /* set the constant current to 495mA, the timeout is 8 hours */
  61   1              CHGCON0  |= 0x01;                    /* enable charger */
  62   1              
  63   1              CHGCON1  |= 0xB8;                    /* set the constant voltage to 4.2V */
  64   1              
  65   1              CHGCON3  |= 0x0A;                    /* charging mode is normal mode */ 
  66   1              
  67   1              CHGCON4  |= 0x01;                    /* enable intermittent constant voltage charging */
  68   1      }
  69          
  70          void vbat_read()
  71          {
  72   1          vbat_mv  = ADCDAT0L + ((ADCDAT01H & 0x0F) << 8);
  73   1          vbat_mv  <<= 4;
  74   1          vbat_mv  >>= 4;
  75   1          vbat_mv  += 2600;
  76   1      }
  77          
  78          void num_handle()
  79          {
  80   1              num[0]  = vbat_mv / 1000 % 10;
  81   1              num[1]  = vbat_mv / 100 % 10;
  82   1              num[2]  = vbat_mv / 10 % 10;
  83   1              num[3]  = vbat_mv % 10;
  84   1              num[4]  = '\0';
  85   1      }
  86          
  87          void HexToChar()
  88          {
  89   1              num[0] = num[0] + 0x30;
  90   1              num[1] = num[1] + 0x30;
  91   1              num[2] = num[2] + 0x30;
  92   1              num[3] = num[3] + 0x30;
  93   1      }
  94          
  95          void uart_tx_8bits(unsigned char V_data)
  96          {
  97   1              SBUF = V_data;
  98   1          while (!TI);
  99   1          TI   = 0;
 100   1      }
 101          
 102          void send_string(unsigned char *p){
 103   1              while (*p != '\0') {
 104   2                      uart_tx_8bits(*p);
 105   2              p++;
 106   2              }
 107   1      }
 108          
 109          int main()
 110          {
 111   1          WDTCON = 0x05;                       /* disable watchdog at startup */
 112   1              
 113   1              MFP1  |= 0x20;
 114   1              MFP2  |= 0x08;
 115   1              MFP3  |= 0x0A;                       /* P06 as UARTTX, P11 as UARTRX */
 116   1              
C51 COMPILER V9.60.0.0   MAIN                                                              11/10/2021 10:38:04 PAGE 3   

 117   1              charger_init();
 118   1              adc_init();
 119   1              uart_init();
 120   1             
 121   1          while (1) {
 122   2                      vbat_read();
 123   2                      num_handle();
 124   2                      HexToChar();
 125   2                      send_string("Vbat: ");
 126   2                      send_string(num);
 127   2                      send_string("mV");
 128   2                      send_string("\n");
 129   2                      _delay_ms(1000);
 130   2          }
 131   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    310    ----
   CONSTANT SIZE    =     12    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      7    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
